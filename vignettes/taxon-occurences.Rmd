---
title: "Taxon occurences"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: yeti
    highlight: tango
vignette: >
  %\VignetteIndexEntry{taxon-occurences}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tscr)
```

# Setup tscr
Read how to [setup](https://dbca-wa.github.io/tscr/articles/setup.html) tscr
to the TSC API.

# Download Taxon Occurrences from TSC
We get Taxon occurrences with their point representation from TSC.
Currently, all Fauna and Flora occurrences have only points, not polygons.
In future, Flora Populations can be captured as polygons representing the entire
population, or a surveyed part of it.

## Areas as table
In this example, we download a subset of 10 Areas, parse the data into a table,
and display selected columns of the downloaded Areas.

```{r areas}
areas <- tsc_GET("area", chunk_size = 100, max_records = 10) %>% tsc_parse()

areas %>% 
  dplyr::select(name, area_type) %>% 
  dplyr::arrange(area_type) %>% 
  knitr::kable()
```

## Areas on a map

In this example, we download Areas of type "Site", convert it to a spatial format
(GeoJSON), and display it on a map. 

See the [Areas API](https://tsc.dbca.wa.gov.au/api/1/area/) for other possible
filters.

See the [mapview](https://r-spatial.github.io/mapview/index.html) homepage for 
map configuration options.


```{r areas_gj, eval=T}
areas_gj <- 
  tsc_GET("area", 
          query = list(area_type="Site"),
          chunk_size = 100) %>% 
  magrittr::extract2("data") %>%
  geojsonio::as.json() %>%
  geojsonsf::geojson_sf()

mapview::mapview(areas_gj)
```

## Download Occurrences
In this example, we download the point representation of Taxon occurrence records.

We limit the result size to 10 records for demonstration purposes, but this
method can also download the entire dataset if the parameter `max_records` is
omitted.

See the [TSC API](https://tsc.dbca.wa.gov.au/api/1/) for the full list of available
endpoints. 

We show here [Taxon Point Occurrences](https://tsc.dbca.wa.gov.au/api/1/occ-taxon-points/).
Each field can serve as a filter via the query attribute.


```{r get_tae}
# Taxon occurrences with their Point representation
tae_res <- tsc_GET("occ-taxon-points", max_records = 10) 
```
## Occurrences as table
We show some fields as an interactive table. The field `as_html` contains 
rendered content which can be used as a map popup.

```{r tae_tbl}
tae <- tae_res %>% tsc_parse()

tae %>% 
  dplyr::select(label, encountered_on, geolocation_capture_method, as_html) %>% 
  janitor::clean_names(case="sentence") %>% 
  reactable::reactable(filterable=TRUE, sortable = TRUE, searchable = TRUE,
                      defaultColDef = reactable::colDef(html=TRUE))
head(tae) %>% knitr::kable()
```

## Occurences on a map
Taxon occurrences as GeoJSON SimpleFeatures for plotting.
We use the field `as_html` as the popup and the geolocation capture method for
grouping.
```{r tae_map}
tae_gj <- tae_res %>%
  magrittr::extract2("data") %>%
  geojsonio::as.json() %>%
  geojsonsf::geojson_sf()

mapview::mapview(tae_gj, popup="as_html", zcol="geolocation_capture_method")
```

# Download all Taxon Occurrences from TSC
We get Taxon occurrences with their point representations from TSC through the 
API endpoint [occ-taxon-points](https://tsc.dbca.wa.gov.au/api/1/occ-taxon-points/).

Currently, all Fauna and Flora occurrences are georeferenced only with point 
coordinates, not polygons.

We then get TSC Areas and split them into DBCA Regions and Districts.
Caveat: Regions and Districts to not comprehensively cover WA.

Lastly, we get a list of taxonomic names from TSC to resolve taxon IDs from
taxon occurrences to names.

Occurrences are presented as `occ` with DBCA Region and District names (where
applicable), plus taxonomic names.

```{r download, eval=F}
datafile <- here::here("data/tae.RData")

tsc_tae <- tsc_GET("occ-taxon-points") # 137k records
tsc_taxa <- tsc_GET("taxon") %>%
    wastdr::wastd_parse() %>%
    dplyr::mutate(name_id = name_id %>% as.character(), taxon = pk)
tsc_areas <- tsc_GET("area") %>%
      magrittr::extract2("features") %>%
      geojsonio::as.json() %>%
      geojsonsf::geojson_sf()
save(tsc_tae, tsc_taxa, tsc_areas, file=datafile, compress="xz")
```

```{r munge, eval=F}
if (fs::file_exists(datafile)) load(datafile)

regions <- tsc_areas %>%
  dplyr::filter(area_type == "Region") %>%
  dplyr::transmute(region_id = pk, region_name = name)

districts <- tsc_areas %>%
  dplyr::filter(area_type == "District") %>%
  dplyr::transmute(district_id = pk, district_name = name)

occ <- tsc_tae %>%
  magrittr::extract2("features") %>%
  geojsonio::as.json() %>%
  geojsonsf::geojson_sf() %>% 
  sf::st_join(regions) %>% 
  sf::st_join(districts) %>% 
  dplyr::left_join(tsc_taxa, by="taxon")
```

# Visualise occurrences

## Species occurrences by DBCA Region

```{r occ_by_reg, eval=FALSE}
occ_by_region <- occ %>% 
    dplyr::group_by(region_name, taxonomic_name) %>% 
    dplyr::tally()  %>% 
    wastdr::sf_as_tbl() %>% 
    tidyr::pivot_wider(
        id_cols=taxonomic_name,
        names_from = region_name,
        values_from = n,
        values_fill = NA
    )
occ_by_region %>% reactable::reactable(sortable = T, filterable = T)
```

## Species occurrences by DBCA District

```{r occ_by_dist, eval=FALSE}
occ_by_district <- occ %>% 
    dplyr::group_by(district_name, taxonomic_name) %>% 
    dplyr::tally()  %>% 
    wastdr::sf_as_tbl() %>% 
    tidyr::pivot_wider(
        id_cols=taxonomic_name,
        names_from = district_name,
        values_from = n,
        values_fill = NA
    )
occ_by_district %>% reactable::reactable(sortable = T, filterable = T)
```
